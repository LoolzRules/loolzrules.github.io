---
title: Беги, Шиншилла!
---
<div id="main">
  <img aria-hidden="true" style="display: none" src="/assets/images/posts/2020/10/e_dubble.jpg">
  <img aria-hidden="true" style="display: none"
       src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA65pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxNTg1QzI1RjIwMDgxMUVCODU1RUZGNkZCMTVFOTI1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxNTg1QzI1RTIwMDgxMUVCODU1RUZGNkZCMTVFOTI1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjAyMCBXaW5kb3dzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9IjU1RUUxOTkyNkZENUFENEY3QTkyM0UxQTBDMzNDNzIxIiBzdFJlZjpkb2N1bWVudElEPSI1NUVFMTk5MjZGRDVBRDRGN0E5MjNFMUEwQzMzQzcyMSIvPiA8ZGM6cmlnaHRzPiA8cmRmOkFsdD4gPHJkZjpsaSB4bWw6bGFuZz0ieC1kZWZhdWx0Ij4oYykgUHVzaGtpbiB8IERyZWFtc3RpbWUuY29tPC9yZGY6bGk+IDwvcmRmOkFsdD4gPC9kYzpyaWdodHM+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+HpHHPgAAADBQTFRF/////8z//8zM/5nM/5mZzP//zMz/zMzMzJmZmczMmZnMmZmZZmZmMzMzAAAA////+mvMvQAAABB0Uk5T////////////////////AOAjXRkAAAO7SURBVHjarJmJcuMgDEAVxyAwdv3/f7uI+zLI22oy0zTTPHRLpnBHgY0E4P6dpO/D9/v1yL8BbjvBHPJPgOB4nshREeDJN1D4LxLXuIm7WyARgcP7fvfhH/rPPm+AEJ29KXgCbhVwTsy84V/+FzDxdiZwlt6Fu4c5NgZu+EgsDR4Z0wXF4RTiQ5IBD1jnIfHQ61jbDgjbeyCiMuiIVh8obQdUigmsXI1BNEZuKDbEw+DGCkoC2sPRYBbtXsTyfKM2tc0UTN0GMrAXrXV8Z5AJ9MR9DxGZSenESYN1RAIuxBo9q7wb6hrYlUG+hnBPgTaQSi0NPgoN7wXwBlyLNfnr2/vnXgNdehgrx0zFfZ8Ms05Dy9NzHZX6TvrRa5Od2cCYy07ENBzkC11U4xooYzk8udCY06aVhpsHDBab87rOZ3M1IhOYeD9WzidYapVrYNLP8pxpjZzXacwLYKUg4NXy6JxrTRwA6Zvn2QKtdkT0mr8EOh1N2bUJCMb5dqUi1HVHxOvnGoTZH3O9AhY6xjEFn0/4mHh00CtgU3qCgFsiXpnHA4qWSL9Tmwofm8yTwEpsElHirLhFB5rJKoEHDIyRNJqzTHaJ02DcKxwUcVY9kMxuYw1uFZNYnSLCQdx+eIdvzIXbHLInp9R5b+iBPpLymafxfgPMvnfuE9atModILPtr58M6C30gZDkDFhOAA7S6pcnq3hh+UMY8QN1sd/BLoGz3ReQC8UHDppY1s/SKzeEBeEyAcRcfA8V7DefASkdkAXEBxJdA4AORA0wl3gBzwqlAFFUCRmxXsVqKIfDIm/m+uQlQLt0pyC0QrM5ybLLOQKsjXb70vA4IOu+MLfDImznZXTz6Je2Paox6L4vUdfsdm3hWQ+dDeoSISldLKFRx1EUb76PsLIKPD3D0oDl0pSjkMNKDYDEWemA/AEReNVPqRGPDzi2fgaPmL8r+FYBuuLgqla4dwbh96eGwl7LL7RS/0NPFQ8eWCSgrYPu8oQ9yKgR7pCyi1JW4P1WItDI0KiY9RZo5skyjwT1eMsUvYDgAFrUuK94Y6JycMpaA7VgpaLKumw4oih3GEa2fRBMRi5BR2gc1GN1d1jkoyeJGQcovj+v6RN/YxChtdF148aj+5nTQegW6nJFQur2ML1RDZAmMjdtiKs/He5v5ajMExnWpFaTn5eUF7eONY8H0P+kBHJd30gNguPSg9V+GIY3Vvdpbk6G4NA3PFrbhIvNKfxwpaC5JX9zoM861k2rn/8+B4xU7APnAfwIMAEDK89hRE75dAAAAAElFTkSuQmCC"/>
  <canvas height="600" width="600"></canvas>
</div>
<script type="text/javascript">
  class GChinchilla {

    static colors = {
      "border": "#a23f12",
      "text": "#f08b5d",
      "green": "#99bf30",
      "yellow": "#e0bc2d",
      "red": "#f14a34",
      "bg": "#000000"
    };

    static directions = {
      "UP": 0,
      "RIGHT": 1,
      "DOWN": 2,
      "LEFT": 3,
      "STOP": 4,
    };

    constructor() {
      this.$c = document.querySelector("#main > canvas");
      this.bg = document.querySelector("#main > img:nth-child(1)");
      this.ch = document.querySelector("#main > img:nth-child(2)");
      this.w = this.$c.width;
      this.h = this.$c.height;
      this.paddings = this.w / 40;
      this.ctx = this.$c.getContext("2d");
      this.ctx.textAlign = "center";
      this.ctx.fillStyle = "black";
      this.ctx.lineWidth = this.paddings;

      const iw = this.w - 2 * this.paddings;
      const ih = iw * 2 / 3;
      this.i = {
        x: this.paddings,
        y: this.h - ih - this.paddings,
        w: iw,
        h: ih,
      };
      this.chinchilla = {
        x: this.i.x,
        y: this.i.y,
        s: this.paddings * 2,
        speed: 0.1875,
      };
      this.previousDirection = GChinchilla.directions.STOP;
      this.currentDirection = GChinchilla.directions.STOP;

      this.bg.onload = () => {
        this.initGame();
        this.addKeyboardControls();
      };
    }

    initGame() {
      this.blackPart = [
        [this.i.x, this.i.y],
        [this.i.x + this.i.w, this.i.y],
        [this.i.x + this.i.w, this.i.y + this.i.h],
        [this.i.x, this.i.y + this.i.h],
      ];
      this.currentPath = [];
      this.time = performance.now();
      this.tick();
    }

    addKeyboardControls() {
      document.addEventListener('keyup', this.processKeyUp.bind(this), false);
    }

    processKeyUp(event) {
      switch (event.code) {
        case "ArrowUp":
        case "KeyW": {
          this.currentDirection = GChinchilla.directions.UP;
          break;
        }
        case "ArrowRight":
        case "KeyD": {
          this.currentDirection = GChinchilla.directions.RIGHT;
          break;
        }
        case "ArrowDown":
        case "KeyS": {
          this.currentDirection = GChinchilla.directions.DOWN;
          break;
        }
        case "ArrowLeft":
        case "KeyA": {
          this.currentDirection = GChinchilla.directions.LEFT;
          break;
        }
        case "Space": {
          this.currentDirection = GChinchilla.directions.STOP;
          break;
        }
        default: {
          return;
        }
      }
    }

    tick() {
      const diff = performance.now() - this.time;
      let isOnTheEdge = false;


      if (this.previousDirection !== this.currentDirection) {
        this.currentPath.push([this.chinchilla.x, this.chinchilla.y]);
      }

      switch (this.currentDirection) {
        case (GChinchilla.directions.UP): {
          let y = this.chinchilla.y - this.chinchilla.speed * diff;
          if (y <= this.i.y) {
            isOnTheEdge = true;
            y = this.i.y;
            this.currentDirection = GChinchilla.directions.STOP;
          }
          this.chinchilla.y = y;
          break;
        }
        case (GChinchilla.directions.RIGHT): {
          let x = this.chinchilla.x + this.chinchilla.speed * diff;
          if (x >= this.i.x + this.i.w) {
            isOnTheEdge = true;
            x = this.i.x + this.i.w;
            this.currentDirection = GChinchilla.directions.STOP;
          }
          this.chinchilla.x = x;
          break;
        }
        case (GChinchilla.directions.DOWN): {
          let y = this.chinchilla.y + this.chinchilla.speed * diff;
          if (y >= this.i.y + this.i.h) {
            isOnTheEdge = true;
            y = this.i.y + this.i.h;
            this.currentDirection = GChinchilla.directions.STOP;
          }
          this.chinchilla.y = y;
          break;
        }
        case (GChinchilla.directions.LEFT): {
          let x = this.chinchilla.x - this.chinchilla.speed * diff;
          if (x <= this.i.x) {
            isOnTheEdge = true;
            x = this.i.x;
            this.currentDirection = GChinchilla.directions.STOP;
          }
          this.chinchilla.x = x;
          break;
        }
        case (GChinchilla.directions.STOP):
        default: {
          break;
        }
      }

      if (isOnTheEdge) {
        if (this.currentPath.length > 1) {
          // close path
        }

        this.currentPath = [[this.chinchilla.x, this.chinchilla.y]];
      }

      this.render();
      this.time = performance.now();
      window.requestAnimationFrame(this.tick.bind(this));
    }

    render() {
      this.drawUI();
      this.drawImage();
      this.drawCharacters();
    }

    drawUI() {
      this.ctx.strokeStyle = GChinchilla.colors.bg;
      const o = this.paddings / 2;
      this.ctx.fillRect(0, 0, this.w, this.h);
      this.ctx.strokeStyle = GChinchilla.colors.border;
      this.ctx.moveTo(o, o);
      this.ctx.lineTo(o, this.w - o);
      this.ctx.lineTo(this.h - o, this.w - o);
      this.ctx.lineTo(this.h - o, o);
      this.ctx.lineTo(o, o);
      this.ctx.stroke();
      this.ctx.moveTo(0, this.h - this.i.h - this.paddings - o);
      this.ctx.lineTo(this.w, this.h - this.i.h - this.paddings - o);
      this.ctx.stroke();
    }

    drawImage() {
      this.ctx.drawImage(this.bg, this.i.x, this.i.y, this.i.w, this.i.h);
      this.ctx.strokeStyle = GChinchilla.colors.bg;
      this.ctx.beginPath();
      const lastPoint = this.blackPart[this.blackPart.length - 1];
      this.ctx.moveTo(lastPoint[0], lastPoint[1]);
      for (const point of this.blackPart) {
        this.ctx.lineTo(point[0], point[1]);
      }
      this.ctx.closePath();
      this.ctx.fill();
    }

    drawCharacters() {
      this.ctx.strokeStyle = 'white';
      if (this.currentPath.length > 1) {
        this.currentPath.forEach((point, idx) => {
          if (idx === 0) {
            this.ctx.moveTo(point[0], point[1]);
          }
          this.ctx.lineTo(point[0], point[1]);
        });
        this.ctx.stroke();
      }
      this.ctx.drawImage(this.ch, this.chinchilla.x - this.paddings, this.chinchilla.y - this.paddings, this.chinchilla.s, this.chinchilla.s);
    }
  }

  const g = new GChinchilla();
</script>